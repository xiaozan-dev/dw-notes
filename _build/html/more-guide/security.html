

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Spark安全 &mdash; Spark 2.2.x 中文文档 2.2.1 文档</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../_static/translations.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="硬件配置" href="hardware-provisioning.html" />
    <link rel="prev" title="Spark 任务调度" href="job-scheduling.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Spark 2.2.x 中文文档
          

          
          </a>

          
            
            
              <div class="version">
                2.2.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../programming-guide/quick-start.html">快速入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="../programming-guide/rdd-guide.html">RDD 编程指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../programming-guide/sql-guide.html">Spark SQL, DataFrame 和 Dataset 编程指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../programming-guide/structured-streaming-guide.html">Structured Streaming编程指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../programming-guide/streaming-guide.html">Spark Streaming 编程指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../programming-guide/ml-guide.html">机器学习库(MLib)编程指南</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../deploy-guide/cluster-overview.html">集群模式概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploy-guide/submitting-applications.html">提交 Spark 应用程序</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploy-guide/spark-standalone.html">Spark 独立模式</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploy-guide/running-on-mesos.html">在Mesos上运行Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploy-guide/running-on-yarn.html">在 YARN 上运行 Spark</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Spark 配置</a></li>
<li class="toctree-l1"><a class="reference internal" href="monitoring.html">监控和工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="tuning.html">Spark 性能调优</a></li>
<li class="toctree-l1"><a class="reference internal" href="job-scheduling.html">Spark 任务调度</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Spark安全</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#web-ui">Web UI</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">认证</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id2">事件日志</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id3">加密</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#ssl">SSL配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="#yarn">YARN模式</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">独立模式</a></li>
<li class="toctree-l3"><a class="reference internal" href="#key-stores">准备key-stores</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sasl">配置SASL加密</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id5">配置网络安全端口</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id6">仅独立部署适用</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">所有集群管理器适用</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="hardware-provisioning.html">硬件配置</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Spark 2.2.x 中文文档</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Spark安全</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/more-guide/security.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="spark">
<h1>Spark安全<a class="headerlink" href="#spark" title="永久链接至标题">¶</a></h1>
<p>Spark 目前已经支持以共享秘钥的方式进行身份认证。开启身份认证配置参数为 spark.authenticate。这个配置参数决定了Spark通讯协议是否使用共享秘钥做身份验证。验证过程就是一个基本的握手过程，确保通讯双方都有相同的秘钥并且可以互相通信。如果共享秘钥不同，双方是不允许通信的。共享秘钥可用以下方式创建：</p>
<ul class="simple">
<li><p>对于以 YARN 方式部署的 Spark，将 spark.authenticate 设为true可以自动生成并分发共享秘钥。每个 Spark 应用会使用唯一的共享秘钥。</p></li>
<li><p>而对于其他部署类型，需要在每个节点上设置 spark.authenticate.secret 参数。这个秘钥将会在由所有 Master/Workers以及各个Spark应用共享。</p></li>
</ul>
<div class="section" id="web-ui">
<h2>Web UI<a class="headerlink" href="#web-ui" title="永久链接至标题">¶</a></h2>
<p>Spark UI 也可以通过配置 spark.ui.filters 来使用 javax servlet filters 确保安全性，</p>
<div class="section" id="id1">
<h3>认证<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p>因为某些用户可能希望web UI上的某些数据应该保密，并对其他用户不可见。用户可以自定义 javax servlet filter 来对登陆用户进行认证，Spark会根据用户的ACL（访问控制列表）来确保该登陆用户有权限访问某个Spark应用的web UI。Spark ACL的行为可由 spark.acls.enable 和 spark.ui.view.acls 共同控制。注意，启动Spark应用的用户总是会有权限访问该应用对应的UI。而在YARN模式下，Spark web UI会使用YARN的web应用代理机制，通过Hadoop过滤器进行认证。</p>
<p>Spark还支持修改运行中的Spark应用对应的ACL以便更改其权限控制，不过这可能会导致杀死应用或者杀死任务的动作。这一特性由 spark.acls.enable 和 spark.modify.acls 共同控制。注意，如果你需要web UI的认证，比如为了能够在web UI上使用杀死应用的按钮，那么就需要将用户同时添加到modify ACL和view ACL中。在YARN上，控制用户修改权限的modify ACL是通过YARN接口传进来的。</p>
<p>Spark可以允许多个管理员共同管理ACL，而且这些管理员总是能够访问和修改所有的Spark应用。而管理员本身是由 spark.admin.acls 配置的。在一个共享的多用户集群中，你可能需要配置多个管理员，另外，该配置也可以用于支持开发人员调试Spark应用。</p>
</div>
</div>
<div class="section" id="id2">
<h2>事件日志<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>如果你启用了事件日志（event logging），那么这些日志对应的目录（spark.eventLog.dir）需要事先手动创建并设置好权限。如果你要限制这些日志文件的权限，首先还是要将日志目录的权限设为 drwxrwxrwxt，目录owner应该是启动history server的超级用户，对应的组限制为该超级用户所在组。这样其他所有用户就只能往该目录下写日志，但同时又不能删除或改名。事件日志文件只有在用户或者用户组具有读写权限时才能写入。</p>
</div>
<div class="section" id="id3">
<h2>加密<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>Spark对Akka和HTTP协议（广播和文件服务器中使用）支持SSL。同时，对数据块传输服务（block transfer service）支持SASL加密。Spark web UI暂时还不支持任何加密。</p>
<p>Spark的临时数据存储，如：混洗中间文件、缓存数据或其他应用相关的临时文件，目前也没有加密。如果需要加密这些数据，只能通过配置集群管理器将数据存储到加密磁盘上。</p>
<div class="section" id="ssl">
<h3>SSL配置<a class="headerlink" href="#ssl" title="永久链接至标题">¶</a></h3>
<p>Spark SSL相关配置是层级式的。用户可以配置SSL的默认配置，以便支持所有的相关通讯协议，当然，如果设置了针对某个具体协议配置值，其值将会覆盖默认配置对应的值。这种方式主要是为了方便用户，用户可以轻松地为所有协议都配置好默认值，同时又不会影响针对某一个具体协议的特殊配置需求。通用的SSL默认配置在 spark.ssl 这一配置命名空间下，对于Akka的SSL配置，在spark.ssl.akka下，而对用于广播和文件服务器中的HTTP协议，其配置在 spark.ssl.fs 下。详细的清单见配置指南（configuration page）。</p>
<p>SSL必须在每个节点上都配置好，并且包括各个使用特定通讯协议的相关模块。</p>
</div>
<div class="section" id="yarn">
<h3>YARN模式<a class="headerlink" href="#yarn" title="永久链接至标题">¶</a></h3>
<p>key-store 文件可以由客户端准备好，然后作为Spark应用的一部分分发到各个执行器（executor）上使用。用户也可以在Spark应用启动前，通过配置 spark.yarn.dist.files 或者 spark.yarn.dist.archives 来部署key-store文件。这些文件传输过程的加密是由YARN本身负责的，和Spark就没什么关系了。</p>
<p>对于一些长期运行并且可以写HDFS的Spark应用，如：Spark Streaming 上的应用，可以用 spark-submit 的 –principal 和 –keytab 参数分别设置principal 和 keytab 信息。keytab文件将会通过 Hadoop Distributed Cache（如果YARN配置了 SSL并且HDFS启用了加密，那么分布式缓存的传输也会被加密） 复制到Application Master所在机器上。Kerberos的登陆信息将会被principal和keytab周期性地刷新，同时HDFS所需的代理token也会被周期性的刷新，这样Spark应用就能持续地写入HDFS了。</p>
</div>
<div class="section" id="id4">
<h3>独立模式<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h3>
<p>独立模式下，用户需要为master和worker分别提供key-store和相关配置选项。这些配置可以通过在SPARK_MASTER_OPTS 和 SPARK_WORKER_OPTS，或者 SPARK_DEAMON_JAVA_OPTS环境变量中添加相应的java系统属性来设置。独立模式下，用户可以通过worker的SSL设置来改变执行器（executor）的配置，因为这些执行器进程都是worker的子进程。不过需要注意的是，执行器如果需要启用本地SSL配置值（如：从worker进程继承而来的环境变量），而不是用户在客户端设置的值，就需要将 spark.ssl.userNodeLocalConf 设为 true。</p>
</div>
<div class="section" id="key-stores">
<h3>准备key-stores<a class="headerlink" href="#key-stores" title="永久链接至标题">¶</a></h3>
<p>key-stores 文件可以由 keytool 程序生成。keytool 相关参考文档见这里：here。独立模式下，配置key-store和trust-store至少有这么几个基本步骤：</p>
<ul class="simple">
<li><p>为每个节点生成一个秘钥对</p></li>
<li><p>导出各节点秘钥对中的公匙（public key）到一个文件</p></li>
<li><p>将所有这些公匙导入到一个 trust-store 文件中</p></li>
<li><p>将该trust-store文件发布到所有节点</p></li>
</ul>
</div>
<div class="section" id="sasl">
<h3>配置SASL加密<a class="headerlink" href="#sasl" title="永久链接至标题">¶</a></h3>
<p>启用认证后（spark.authenticate），数据块传输服务（block transfer service）可以支持SASL加密。如需启用SASL加密的话，还需要在 Spark 应用中设置 spark.authenticate.enableSaslEncryption 为 true。</p>
<p>如果是开启了外部混洗服务（external shuffle service），那么只需要将 spark.network.sasl.serverAlwaysEncrypt 设为true即可禁止非加密的网络连接。因为这个配置一旦启用，所有未使用 SASL加密的Spark应用都无法连接到外部混洗服务上。</p>
</div>
</div>
<div class="section" id="id5">
<h2>配置网络安全端口<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h2>
<p>Spark计算过程中大量使用网络通信，而有些环境中对网络防火墙的设置要求很严格。下表列出来Spark用于通讯的一些主要端口，以及如何配置这些端口。</p>
<div class="section" id="id6">
<h3>仅独立部署适用<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h3>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 25%" />
<col style="width: 19%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>访问源</p></th>
<th class="head"><p>访问目标</p></th>
<th class="head"><p>默认端口</p></th>
<th class="head"><p>用途</p></th>
<th class="head"><p>配置</p></th>
<th class="head"><p>注意</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Browser</p></td>
<td><p>Standalone Master</p></td>
<td><p>8080</p></td>
<td><p>Web UI</p></td>
<td><p>spark.master.ui.port/SPARK_MASTER_WEBUI_PORT</p></td>
<td><p>基于Jetty。仅独立模式有效。</p></td>
</tr>
<tr class="row-odd"><td><p>Browser</p></td>
<td><p>Standalone Worker</p></td>
<td><p>8081</p></td>
<td><p>Web UI</p></td>
<td><p>spark.worker.ui.port/SPARK_WORKER_WEBUI_PORT</p></td>
<td><p>基于Jetty。仅独立模式有效。</p></td>
</tr>
<tr class="row-even"><td><p>Driver/Standalone Worker</p></td>
<td><p>Standalone Master</p></td>
<td><p>7077</p></td>
<td><p>提交作业/合并集群</p></td>
<td><p>SPARK_MASTER_PORT</p></td>
<td><p>设为0表示随机。仅独立模式有效。</p></td>
</tr>
<tr class="row-odd"><td><p>Standalone Master</p></td>
<td><p>Standalone Worker</p></td>
<td><p>(random)</p></td>
<td><p>调度执行器</p></td>
<td><p>SPARK_WORKER_PORT</p></td>
<td><p>设为0表示随机。仅独立模式有效。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id7">
<h3>所有集群管理器适用<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h3>
<p>更多关于安全方面的配置参数，请参考配置指南（configuration page），安全方面的一些实现细节可以参考 org.apache.spark.SecurityManager。</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="hardware-provisioning.html" class="btn btn-neutral float-right" title="硬件配置" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="job-scheduling.html" class="btn btn-neutral float-left" title="Spark 任务调度" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, jackiehff

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>